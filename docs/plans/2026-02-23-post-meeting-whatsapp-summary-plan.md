# Post-Meeting WhatsApp Summary — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Automatically send a compact meeting summary + action items to users on WhatsApp, 15 minutes after meeting insights are generated by AYA.

**Architecture:** New Inngest function triggered by `meeting/insights.ready` event. Sleeps 15 min, checks eligibility (user has WhatsApp + opt-in enabled), formats insights into a WhatsApp-friendly message, sends via WAHA `sendText()`. Two new DB fields track opt-in preference and prevent duplicate sends.

**Tech Stack:** Inngest (event-driven functions), Prisma (ORM), WAHA (WhatsApp HTTP API), TypeScript/Next.js

**Note:** Do NOT run `npx prisma generate` or `npx prisma migrate` — the developer handles migrations manually.

---

### Task 1: Add schema fields to Prisma

**Files:**
- Modify: `prisma/schema.prisma` (User model ~line 54, Meeting model ~line 648)

**Step 1: Add `whatsappMeetingSummaryEnabled` to User model**

In `prisma/schema.prisma`, find the User model. After the `whatsappDigestEnabled` field (line 54), add:

```prisma
whatsappMeetingSummaryEnabled Boolean @default(false)
```

**Step 2: Add `whatsappSummarySentAt` to Meeting model**

In the Meeting model, after the `metadata` field (line 648), add:

```prisma
whatsappSummarySentAt DateTime?  // Prevents duplicate WhatsApp summary sends
```

**Step 3: Verify schema is valid**

Run: `npx prisma validate`
Expected: "The schema is valid."

**Step 4: Commit**

```bash
git add prisma/schema.prisma
git commit -m "feat(schema): add whatsappMeetingSummaryEnabled and whatsappSummarySentAt fields"
```

---

### Task 2: Create the meeting summary WhatsApp formatter

**Files:**
- Create: `lib/whatsapp/meeting-summary-formatter.ts`

**Step 1: Create the formatter file**

Create `lib/whatsapp/meeting-summary-formatter.ts` with the following content:

```typescript
/**
 * Format meeting insights into a WhatsApp-friendly summary message.
 *
 * Produces a compact message with:
 * - Meeting title + metadata (date, duration, participant count)
 * - Executive summary (2-3 sentences)
 * - Numbered action items with owners
 */

interface ActionItem {
  task: string;
  owner: string;
  deadline?: string | null;
}

interface FormatMeetingSummaryInput {
  title: string;
  scheduledStart: Date;
  duration: number | null; // seconds
  participantCount: number;
  summary: string;
  actionItems: ActionItem[];
  timezone: string;
}

/**
 * Format a date in the user's timezone for WhatsApp display.
 */
function formatMeetingDate(date: Date, timezone: string): string {
  try {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: timezone,
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric",
    }).format(date);
  } catch {
    return date.toLocaleDateString("en-US", {
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  }
}

/**
 * Format duration from seconds to human-readable string.
 */
function formatDuration(seconds: number | null): string {
  if (!seconds || seconds <= 0) return "Unknown duration";
  const minutes = Math.round(seconds / 60);
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}m` : `${hours}h`;
}

/**
 * Build the WhatsApp message from meeting insights.
 */
export function formatMeetingWhatsAppSummary(
  input: FormatMeetingSummaryInput
): string {
  const {
    title,
    scheduledStart,
    duration,
    participantCount,
    summary,
    actionItems,
    timezone,
  } = input;

  const date = formatMeetingDate(scheduledStart, timezone);
  const durationStr = formatDuration(duration);
  const participantStr =
    participantCount === 1
      ? "1 participant"
      : `${participantCount} participants`;

  let message = `*Meeting Summary: ${title}*\n`;
  message += `_${date} | ${durationStr} | ${participantStr}_\n\n`;

  // Executive summary
  message += `*Executive Summary*\n`;
  message += `${summary}\n`;

  // Action items (only if there are any)
  if (actionItems.length > 0) {
    message += `\n*Action Items*\n`;
    actionItems.forEach((item, index) => {
      const owner = item.owner && item.owner !== "Unassigned" ? item.owner : "TBD";
      message += `${index + 1}. ${owner} - ${item.task}\n`;
    });
  }

  message += `\n_Sent by AYA_`;

  return message;
}
```

**Step 2: Verify no TypeScript errors**

Run: `npx tsc --noEmit lib/whatsapp/meeting-summary-formatter.ts` (or rely on IDE)

**Step 3: Commit**

```bash
git add lib/whatsapp/meeting-summary-formatter.ts
git commit -m "feat(whatsapp): add meeting summary formatter for WhatsApp messages"
```

---

### Task 3: Create the Inngest function for delayed WhatsApp delivery

**Files:**
- Create: `lib/inngest/functions/meeting-whatsapp-summary.ts`

**Step 1: Create the Inngest function**

Create `lib/inngest/functions/meeting-whatsapp-summary.ts`:

```typescript
import { inngest } from "../client";
import { prisma } from "@/lib/prisma";
import { sendText, toChatId } from "@/lib/integrations/waha";
import { formatMeetingWhatsAppSummary } from "@/lib/whatsapp/meeting-summary-formatter";

/**
 * Send meeting summary via WhatsApp, 15 minutes after insights are ready.
 *
 * Trigger: "meeting/insights.ready" event (emitted by generateMeetingInsights)
 * Flow: sleep 15 min → check eligibility → format message → send via WAHA
 */
export const sendMeetingWhatsAppSummary = inngest.createFunction(
  {
    id: "send-meeting-whatsapp-summary",
    retries: 3,
  },
  { event: "meeting/insights.ready" },
  async ({ event, step }) => {
    const { meetingId, userId } = event.data;

    console.log(
      `[wa-meeting-summary] Received insights.ready for meeting ${meetingId}, waiting 15 minutes`
    );

    // Wait 15 minutes before sending
    await step.sleep("wait-15-minutes", "15m");

    // Check eligibility: user has WhatsApp, feature enabled, not already sent
    const eligibility = await step.run("check-eligibility", async () => {
      const meeting = await prisma.meeting.findUnique({
        where: { id: meetingId },
        select: {
          id: true,
          title: true,
          status: true,
          whatsappSummarySentAt: true,
          scheduledStart: true,
          duration: true,
          userId: true,
          user: {
            select: {
              id: true,
              whatsappPhone: true,
              whatsappMeetingSummaryEnabled: true,
              timezone: true,
            },
          },
        },
      });

      if (!meeting) {
        return { eligible: false, reason: "meeting_not_found" } as const;
      }

      if (meeting.whatsappSummarySentAt) {
        return { eligible: false, reason: "already_sent" } as const;
      }

      if (!meeting.user.whatsappPhone) {
        return { eligible: false, reason: "no_whatsapp_phone" } as const;
      }

      if (!meeting.user.whatsappMeetingSummaryEnabled) {
        return { eligible: false, reason: "feature_disabled" } as const;
      }

      return { eligible: true, meeting } as const;
    });

    if (!eligibility.eligible) {
      console.log(
        `[wa-meeting-summary] Skipping meeting ${meetingId}: ${eligibility.reason}`
      );
      return { sent: false, reason: eligibility.reason };
    }

    const { meeting } = eligibility;

    // Fetch insights and participants, then format the message
    const message = await step.run("fetch-and-format", async () => {
      // Fetch summary and action_items insights
      const insights = await prisma.meetingInsight.findMany({
        where: {
          meetingId,
          type: { in: ["summary", "action_items"] },
        },
      });

      const summaryInsight = insights.find((i) => i.type === "summary");
      const actionItemsInsight = insights.find(
        (i) => i.type === "action_items"
      );

      const summary = summaryInsight?.content || "No summary available.";

      let actionItems: Array<{
        task: string;
        owner: string;
        deadline?: string | null;
      }> = [];
      if (actionItemsInsight?.content) {
        try {
          actionItems = JSON.parse(actionItemsInsight.content);
        } catch {
          console.warn(
            `[wa-meeting-summary] Failed to parse action items for meeting ${meetingId}`
          );
        }
      }

      // Get participant count
      const participantCount = await prisma.meetingParticipant.count({
        where: { meetingId },
      });

      return formatMeetingWhatsAppSummary({
        title: meeting.title,
        scheduledStart: new Date(meeting.scheduledStart),
        duration: meeting.duration,
        participantCount,
        summary,
        actionItems,
        timezone: meeting.user.timezone || "UTC",
      });
    });

    // Send via WAHA
    await step.run("send-whatsapp", async () => {
      const chatId = toChatId(meeting.user.whatsappPhone!);
      await sendText(chatId, message);

      // Mark as sent to prevent duplicates
      await prisma.meeting.update({
        where: { id: meetingId },
        data: { whatsappSummarySentAt: new Date() },
      });

      console.log(
        `[wa-meeting-summary] Sent summary for meeting ${meetingId} to ${meeting.user.whatsappPhone}`
      );
    });

    return { sent: true, meetingId };
  }
);
```

**Step 2: Commit**

```bash
git add lib/inngest/functions/meeting-whatsapp-summary.ts
git commit -m "feat(whatsapp): add Inngest function for delayed meeting summary delivery"
```

---

### Task 4: Emit the `meeting/insights.ready` event from `generateMeetingInsights`

**Files:**
- Modify: `lib/inngest/functions/meeting-orchestration.ts` (after line 780, inside `generateMeetingInsights`)

**Step 1: Add the event emission**

In `lib/inngest/functions/meeting-orchestration.ts`, find the `generateMeetingInsights` function. After the `notify-insights-ready` step (line 780), and before the final `console.log` (line 782), add a new step:

```typescript
    // Trigger delayed WhatsApp summary delivery
    await step.run("trigger-whatsapp-summary", async () => {
      await inngest.send({
        name: "meeting/insights.ready",
        data: {
          meetingId,
          userId: meeting.userId,
        },
      });
    });
```

This should be inserted between the closing `});` of the `notify-insights-ready` step and the `console.log` line.

**Step 2: Verify the file still compiles**

Run: `npx tsc --noEmit` (or check IDE for errors)

**Step 3: Commit**

```bash
git add lib/inngest/functions/meeting-orchestration.ts
git commit -m "feat(meetings): emit meeting/insights.ready event after insight generation"
```

---

### Task 5: Register the new Inngest function

**Files:**
- Modify: `app/api/inngest/route.ts`

**Step 1: Add the import**

At the top of `app/api/inngest/route.ts`, add the import after the existing meeting orchestration imports (after line 22):

```typescript
import { sendMeetingWhatsAppSummary } from "@/lib/inngest/functions/meeting-whatsapp-summary";
```

**Step 2: Add to the functions array**

In the `functions` array inside `serve()`, add `sendMeetingWhatsAppSummary` after the existing meeting functions (after the `pollMeetingStatuses` entry, around line 49). Add it with a comment:

```typescript
    sendMeetingWhatsAppSummary, // Delayed WhatsApp meeting summary (15 min after insights)
```

**Step 3: Commit**

```bash
git add app/api/inngest/route.ts
git commit -m "feat(inngest): register sendMeetingWhatsAppSummary function"
```

---

### Task 6: Manual verification

**Step 1: Ensure Prisma schema validates**

Run: `npx prisma validate`
Expected: "The schema is valid."

**Step 2: Check TypeScript compilation**

Run: `npx tsc --noEmit`
Expected: No errors related to the new files.

**Step 3: Verify Inngest function registration**

Start the dev server and check the Inngest dashboard at `http://localhost:8288`. The new `send-meeting-whatsapp-summary` function should appear in the function list.

**Step 4: End-to-end smoke test (after migration)**

1. Developer runs `npx prisma migrate dev` to apply schema changes
2. Enable the feature for a test user: `UPDATE "User" SET "whatsappMeetingSummaryEnabled" = true WHERE email = 'test@example.com'`
3. Complete a meeting (or manually trigger `meeting/generate.insights` via Inngest dashboard)
4. Observe the `meeting/insights.ready` event in Inngest dashboard
5. After 15 minutes, verify WhatsApp message arrives

---

## Summary of all changes

| # | File | Action | Description |
|---|------|--------|-------------|
| 1 | `prisma/schema.prisma` | Modify | Add `whatsappMeetingSummaryEnabled` (User), `whatsappSummarySentAt` (Meeting) |
| 2 | `lib/whatsapp/meeting-summary-formatter.ts` | Create | Format meeting insights into WhatsApp message |
| 3 | `lib/inngest/functions/meeting-whatsapp-summary.ts` | Create | Inngest function: sleep 15 min, check eligibility, format, send |
| 4 | `lib/inngest/functions/meeting-orchestration.ts` | Modify | Emit `meeting/insights.ready` event after insight generation |
| 5 | `app/api/inngest/route.ts` | Modify | Register `sendMeetingWhatsAppSummary` in Inngest serve config |
