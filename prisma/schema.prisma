// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum MessageChannel {
  SMS
  WHATSAPP
  EMAIL
  TWITTER
  FACEBOOK
  SLACK
  INSTAGRAM
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
  SCHEDULED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  emailVerified       Boolean   @default(false)
  image               String?
  role                UserRole  @default(EDITOR)
  timezone            String?   @default("UTC") // IANA timezone (e.g., "America/New_York", "Europe/London")
  onboardingCompleted Boolean   @default(false) // Set to true after user completes onboarding
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  messages      Message[]
  notes         Note[]
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  sessions      Session[] @relation("UserSessions")
  accounts      Account[] @relation("UserAccounts")
  
  // CRM relations
  createdSpaces Space[]    @relation("SpaceCreator")
  spaceMembers  SpaceMember[] @relation("SpaceMembers")
  assignedTasks Task[]    @relation("TaskAssignee")
  createdTasks  Task[]    @relation("TaskCreator")
  taskComments TaskComment[] @relation("TaskCommentAuthor")
  
  // Chat relations
  teamChats     TeamChat[] @relation("TeamChatSender")
  chatReads     TeamChatRead[] @relation("TeamChatReads")
  
  // Notifications
  notifications Notification[] @relation("UserNotifications")
  
  // AI Chat relations
  aiChatConversations AIChatConversation[] @relation("AIChatUser")

  // Meeting relations
  meetings            Meeting[]
  meetingBotSettings  MeetingBotSettings?

  // Command Center relations
  signalDismissals    SignalDismissal[]

  // Task watching and reactions
  watchedTasks        TaskWatcher[]
  commentReactions    TaskCommentReaction[]

  @@index([teamId])
  @@index([email])
}

model Team {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  contacts  Contact[]
  invites   TeamInvite[]
  spaces    Space[]
  chats     TeamChat[]
  meetings  Meeting[]
}

model TeamInvite {
  id          String   @id @default(cuid())
  email       String
  teamId      String
  invitedBy   String
  role        UserRole @default(EDITOR)
  token       String   @unique
  teamCode    String   @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([email, teamId])
  @@index([token])
  @@index([teamCode])
  @@index([email])
  @@index([teamId])
}

model Contact {
  id              String    @id @default(cuid())
  name            String?
  phone           String?
  email           String?
  twitterHandle   String?
  facebookId      String?
  tags            String[]
  customFields    Json?
  isVerified      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  teamId          String?
  team            Team?     @relation(fields: [teamId], references: [id])
  
  messages        Message[]
  notes           Note[]
  
  @@index([phone])
  @@index([email])
  @@index([teamId])
}

model Message {
  id              String           @id @default(cuid())
  content         String
  channel         MessageChannel
  direction       MessageDirection
  status          MessageStatus    @default(SENT)
  externalId      String?
  metadata        Json?
  mediaUrls       String[]
  scheduledFor    DateTime?
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  contactId       String
  contact         Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?            @relation(fields: [userId], references: [id])
  
  parentId        String?
  parent          Message?         @relation("MessageThread", fields: [parentId], references: [id])
  replies         Message[]        @relation("MessageThread")
  
  @@index([contactId])
  @@index([channel])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@index([externalId])
}

model Note {
  id          String    @id @default(cuid())
  content     String
  isPrivate   Boolean   @default(false)
  mentions    String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  contactId   String
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  
  parentId    String?
  parent      Note?     @relation("NoteThread", fields: [parentId], references: [id])
  replies     Note[]    @relation("NoteThread")
  
  @@index([contactId])
  @@index([authorId])
}

model Integration {
  id          String   @id @default(cuid())
  name        String   // e.g., "gmail", "outlook", "slack"
  type        String   // e.g., "pipedream", "oauth", "api_key"
  config      Json     // Platform-specific configuration
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // OAuth credentials - stored securely
  accessToken       String?   // Current access token
  refreshToken      String?   // Refresh token for renewing access
  tokenExpiresAt    DateTime? // When the access token expires
  
  // Metadata
  accountId         String?   // External account/app ID from provider
  userId            String?   // Which user this integration belongs to
  teamId            String?   // Which team this integration belongs to
  
  @@unique([name, type, userId, teamId])
  @@index([userId])
  @@index([teamId])
  @@index([name, isActive])
}

model Analytics {
  id              String   @id @default(cuid())
  channel         MessageChannel
  metric          String
  value           Float
  metadata        Json?
  recordedAt      DateTime @default(now())
  
  @@index([channel])
  @@index([metric])
  @@index([recordedAt])
}

model Webhook {
  id          String   @id @default(cuid())
  source      String
  payload     Json
  processed   Boolean  @default(false)
  error       String?
  createdAt   DateTime @default(now())
  
  @@index([source])
  @@index([processed])
}

// Better Auth tables
model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  userId    String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Account {
  id                String  @id @default(cuid())
  accountId         String
  providerId        String
  userId            String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation("UserAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}

// CRM Models
enum TaskListType {
  DEV_ROADMAP
  BUG_TRACKING
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TaskStatus {
  OPEN
  READY
  ONGOING
  NEED_RESOLVING
  CLOSED
  IMPROVEMENT
  NOT_A_BUG
}

model Space {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  // For UI color coding
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy   String
  creator     User     @relation("SpaceCreator", fields: [createdBy], references: [id])
  
  folders     Folder[]
  taskLists   TaskList[]
  members     SpaceMember[]
  
  @@index([teamId])
  @@index([createdBy])
}

model SpaceMember {
  id        String   @id @default(cuid())
  spaceId   String
  userId    String
  role      UserRole @default(EDITOR)
  createdAt DateTime @default(now())
  
  space     Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user      User     @relation("SpaceMembers", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([spaceId, userId])
  @@index([spaceId])
  @@index([userId])
}

model Folder {
  id          String   @id @default(cuid())
  name        String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  spaceId     String
  space       Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  taskLists   TaskList[]
  
  @@index([spaceId])
}

model TaskList {
  id          String        @id @default(cuid())
  name        String
  type        TaskListType
  description String?
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  spaceId     String?
  space       Space?        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  folderId    String?
  folder      Folder?       @relation(fields: [folderId], references: [id], onDelete: Cascade)
  
  tasks       Task[]
  statuses    TaskStatusColumn[]
  
  @@index([spaceId])
  @@index([folderId])
}

model TaskStatusColumn {
  id          String   @id @default(cuid())
  name        String
  color       String?  // For UI color coding
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  taskListId  String
  taskList    TaskList @relation(fields: [taskListId], references: [id], onDelete: Cascade)
  
  tasks       Task[]
  
  @@index([taskListId])
}

model Task {
  id          String       @id @default(cuid())
  name        String
  description String?
  taskId      String?      // Custom task ID like "5bxr"
  priority    TaskPriority @default(NORMAL)
  progress    Int          @default(0) // 0-100
  complexity  Int?         // 1-5 stars
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  taskListId  String
  taskList    TaskList     @relation(fields: [taskListId], references: [id], onDelete: Cascade)
  
  statusId     String?
  status       TaskStatusColumn? @relation(fields: [statusId], references: [id], onDelete: SetNull)
  
  assigneeId   String?
  assignee     User?       @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdById  String
  creator      User        @relation("TaskCreator", fields: [createdById], references: [id])
  
  comments     TaskComment[]
  tags         String[]
  metadata     Json?       // For custom fields
  watchers     TaskWatcher[]

  @@index([taskListId])
  @@index([statusId])
  @@index([assigneeId])
  @@index([createdById])
  @@index([dueDate])
}

model TaskComment {
  id          String   @id @default(cuid())
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId    String
  author      User     @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  parentId    String?
  parent      TaskComment? @relation("CommentThread", fields: [parentId], references: [id])
  replies     TaskComment[] @relation("CommentThread")
  reactions   TaskCommentReaction[]

  @@index([taskId])
  @@index([authorId])
}

model TeamChat {
  id          String   @id @default(cuid())
  content     String
  type        String   @default("text") // text, file, audio, image
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  mimeType    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  readAt      DateTime?
  
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  senderId    String
  sender      User     @relation("TeamChatSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  parentId    String?
  parent      TeamChat? @relation("ChatThread", fields: [parentId], references: [id])
  replies     TeamChat[] @relation("ChatThread")
  
  readBy      TeamChatRead[] @relation("TeamChatReads")
  
  @@index([teamId])
  @@index([senderId])
  @@index([createdAt])
  @@index([parentId])
}

model TeamChatRead {
  id          String   @id @default(cuid())
  readAt      DateTime @default(now())
  
  chatId      String
  chat        TeamChat @relation("TeamChatReads", fields: [chatId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation("TeamChatReads", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  read      Boolean  @default(false)
  readAt    DateTime?
  link      String?  // Optional link to navigate to
  metadata  Json?    // Additional data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// AI Chat Models
model AIChatConversation {
  id          String   @id @default(cuid())
  title       String?  // Auto-generated from first message or user-provided
  model       String   @default("sonnet-4.5") // AI model used
  metadata    Json?    // Additional conversation metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation("AIChatUser", fields: [userId], references: [id], onDelete: Cascade)
  
  messages    AIChatMessage[]
  
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model AIChatMessage {
  id            String   @id @default(cuid())
  role          String   // "user" or "assistant"
  content       String   // Message content
  model         String?  // AI model used for this message
  metadata      Json?    // Additional message metadata (files, thinking, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  conversationId String
  conversation   AIChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// Meeting Bot Models
enum MeetingStatus {
  SCHEDULED    // Bot is scheduled to join
  JOINING      // Bot is currently joining
  IN_PROGRESS  // Meeting is active, bot is recording
  PROCESSING   // Meeting ended, processing transcript
  COMPLETED    // Transcript and insights ready
  FAILED       // Bot failed to join or record
  CANCELLED    // Meeting was cancelled
}

enum MeetingPlatform {
  GOOGLE_MEET
  ZOOM
  MICROSOFT_TEAMS
}

enum RecordingMode {
  SPEAKER_VIEW
  GALLERY_VIEW
  AUDIO_ONLY
}

model MeetingBotSettings {
  id              String        @id @default(cuid())
  botName         String        @default("AYA Meeting Assistant")
  botImage        String?       // Avatar URL for the bot
  entryMessage    String?       // Message bot sends when joining
  recordingMode   RecordingMode @default(SPEAKER_VIEW)
  autoJoinEnabled Boolean       @default(true) // Auto-join calendar meetings
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Meeting {
  id                String          @id @default(cuid())
  title             String
  description       String?
  meetingUrl        String          // Google Meet/Zoom/Teams URL
  platform          MeetingPlatform
  status            MeetingStatus   @default(SCHEDULED)
  scheduledStart    DateTime
  scheduledEnd      DateTime?
  actualStart       DateTime?
  actualEnd         DateTime?
  duration          Int?            // Duration in seconds

  // MeetingBaas references
  botId             String?         // MeetingBaas bot ID
  calendarEventId   String?         // Google Calendar event ID
  recordingUrl      String?         // URL to the recording
  botExcluded       Boolean         @default(false) // User opted out of bot for this meeting

  // Metadata
  errorMessage      String?         // Error details if failed
  metadata          Json?           // Additional platform-specific data
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId            String?
  team              Team?           @relation(fields: [teamId], references: [id], onDelete: SetNull)

  transcript        MeetingTranscript?
  insights          MeetingInsight[]
  participants      MeetingParticipant[]

  @@index([userId])
  @@index([teamId])
  @@index([status])
  @@index([scheduledStart])
  @@index([botId])
  @@index([calendarEventId])
}

model MeetingTranscript {
  id            String   @id @default(cuid())
  fullText      String   // Complete transcript text
  segments      Json     // Array of {speaker, text, startTime, endTime}
  language      String?  @default("en")
  wordCount     Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  meetingId     String   @unique
  meeting       Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
}

model MeetingInsight {
  id              String   @id @default(cuid())
  type            String   // "summary", "action_items", "key_topics", "decisions", "questions"
  content         String   // The insight content (can be JSON for structured data)
  confidence      Float?   // AI confidence score
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  meetingId       String
  meeting         Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([type])
}

model MeetingParticipant {
  id            String   @id @default(cuid())
  name          String
  email         String?
  joinedAt      DateTime?
  leftAt        DateTime?
  speakingTime  Int?     // Speaking time in seconds
  createdAt     DateTime @default(now())

  meetingId     String
  meeting       Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([email])
}

// Command Center Models
model SignalDismissal {
  id          String    @id @default(cuid())
  userId      String
  signalKey   String    // "task:123:blocked" - unique identifier for signal
  type        String    // "dismiss" | "snooze" | "acknowledge"
  snoozeUntil DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, signalKey])
  @@index([userId])
  @@index([snoozeUntil])
}

// Task watching for notifications
model TaskWatcher {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

// Comment reactions (likes/dislikes)
model TaskCommentReaction {
  id        String   @id @default(cuid())
  type      String   // "like" | "dislike"
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment   TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}